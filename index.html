<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<meta http-equiv="Cache-Control" content="no-cache">

<title>Indonesia Radiation Data Monitoring System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>

html,body{
margin:0;
padding:0;
font-family:Arial;
}

#header{
position:absolute;
top:0;
left:0;
width:100%;
height:70px;
background:#0b1e3f;
display:flex;
align-items:center;
padding:0 25px;
color:white;
z-index:9999;
}

#map{
position:absolute;
top:70px;
bottom:60px;
width:100%;
}

#timeline{
position:absolute;
bottom:0;
left:0;
width:100%;
height:60px;
background:white;
border-top:1px solid #aaa;
display:flex;
align-items:center;
padding:10px;
z-index:9999;
}

#slider{
width:100%;
}

.unit-label{
background:rgba(255,255,255,0.8);
border-radius:6px;
padding:3px 6px;
font-size:11px;
font-weight:bold;
border:1px solid rgba(0,0,0,0.2);
}

.legend{
background:white;
padding:10px;
box-shadow:0 2px 6px rgba(0,0,0,0.3);
font-size:12px;
}

</style>
</head>

<body>

<div id="header">
<img src="logo/logo-bapeten.png" height="40">
<h2 style="margin-left:15px;">Indonesia Radiation Data Monitoring System</h2>
</div>

<div id="map"></div>

<div id="timeline">
<input type="range" id="slider" min="0" max="100" value="100">
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>

var osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

var googleHybrid=L.tileLayer(
'https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}
);

var googleSat=L.tileLayer(
'https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}
);

var map=L.map('map',{
center:[-2,118],
zoom:5,
layers:[osm]
});

var stationLayer=L.layerGroup().addTo(map);
var labelLayer=L.layerGroup().addTo(map);
var windLayer=L.layerGroup().addTo(map);

L.control.layers(
{
"OpenStreetMap":osm,
"Google Hybrid":googleHybrid,
"Google Satellite":googleSat
},
{
"Stations":stationLayer,
"Labels":labelLayer,
"Wind":windLayer
}
).addTo(map);

function getRadius(){

var z=map.getZoom();

if(z<=5) return 30000;
if(z<=6) return 20000;
if(z<=7) return 12000;
if(z<=8) return 8000;
if(z<=9) return 5000;
if(z<=10) return 3000;

return 1500;

}

function createHex(lat,lon,radius,color,options={}){

var coords=[];

for(var i=0;i<6;i++){

var angle=(Math.PI/180)*(60*i);

var dx=radius*Math.cos(angle);
var dy=radius*Math.sin(angle);

coords.push([
lat+(dy/111111),
lon+(dx/(111111*Math.cos(lat*Math.PI/180)))
]);

}

return L.polygon(coords,{
color:options.stroke || "white",
weight:options.weight || 1.8,
fillColor:color,
fillOpacity:options.opacity || 0.85
});

}

function getColor(d){

if(d==="Out of service") return "#2b83ba";

d=parseFloat(d);

if(d<1000) return "#2b83ba";
if(d<100000) return "#ffe600";
if(d<1000000) return "#ff9b00";

return "#ff2b2b";

}

function loadStations(csv){

stationLayer.clearLayers();
labelLayer.clearLayers();

var radius=getRadius();

var data=Papa.parse(csv,{header:true}).data;

data.forEach(row=>{

if(!row["LATITUDE"]) return;

var lat=parseFloat(row["LATITUDE"]);
var lon=parseFloat(row["LONGITUDE"]);
var dose=row["Gamma Dose Rate (nSv/h)"];

var color=getColor(dose);

var hex;

if(dose==="Out of service"){

hex=createHex(lat,lon,radius,color,{
opacity:0.25,
stroke:"#004a8f",
weight:2.5
});

}else{

hex=createHex(lat,lon,radius,color,{});

}

var popup;

if(dose==="Out of service"){

popup="<b>"+row["NAMA UNIT"]+"</b><br>Status: Out of Service<br>"+row["LAST UPDATE (WIB)"];

}else{

popup="<b>"+row["NAMA UNIT"]+"</b><br>"+dose+" nSv/h<br>"+row["LAST UPDATE (WIB)";

}

hex.bindPopup(popup);

hex.addTo(stationLayer);

if(map.getZoom()>6){

var label=L.marker([lat+0.15,lon],{

icon:L.divIcon({
html:'<div class="unit-label">'+row["NAMA UNIT"]+'</div>'
})

});

label.addTo(labelLayer);

}

});

}

function loadCSV(){

fetch("output.csv?"+Date.now())
.then(r=>r.text())
.then(loadStations);

}

function loadWind(){

fetch("wind.csv?"+Date.now())

.then(r=>r.text())

.then(text=>{

windLayer.clearLayers();

var data=Papa.parse(text,{header:true}).data;

data.forEach(w=>{

var lat=parseFloat(w.lat);
var lon=parseFloat(w.lon);

var speed=parseFloat(w.speed);
var dir=parseFloat(w.dir);

var length=speed*0.02;

var lat2=lat+(length*Math.cos((dir-90)*Math.PI/180));
var lon2=lon+(length*Math.sin((dir-90)*Math.PI/180));

var arrow=L.polyline([[lat,lon],[lat2,lon2]],{color:"cyan",weight:2});

arrow.addTo(windLayer);

});

});

}

loadCSV();
loadWind();

setInterval(loadCSV,30000);
setInterval(loadWind,60000);

map.on("zoomend",loadCSV);

var slider=document.getElementById("slider");

slider.oninput=function(){

var t=this.value;

fetch("historical.csv")

.then(r=>r.text())

.then(text=>{

var data=Papa.parse(text,{header:true}).data;

var filtered=data.filter(d=>d.time_index==t);

loadStations(Papa.unparse(filtered));

});

};

var legend=L.control({position:"bottomleft"});

legend.onAdd=function(){

var div=L.DomUtil.create("div","legend");

div.innerHTML=`

<b>IAEA Operational Intervention Levels</b><br><br>

<div style="width:240px;height:14px;
background:linear-gradient(to right,#2b83ba,#ffe600,#ff9b00,#ff2b2b);
border:1px solid #999"></div>

<div style="display:flex;justify-content:space-between;width:240px">
<span>0</span>
<span>1000</span>
<span>100000</span>
<span>1000000</span>
</div>

Gamma Dose Rate (nSv/h)

`;

return div;

};

legend.addTo(map);

</script>

</body>
</html>
