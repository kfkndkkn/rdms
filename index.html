<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Indonesia Radiation Data Monitoring System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

html,body{
margin:0;
padding:0;
font-family:Arial;
}

#header{
position:absolute;
top:0;
left:0;
width:100%;
height:70px;
background:#0b1e3f;
display:flex;
align-items:center;
padding:0 25px;
color:white;
z-index:9999;
}

#header img{
height:42px;
margin-right:15px;
}

#map{
position:absolute;
top:70px;
bottom:0;
width:100%;
}

.unit-label{
background:rgba(255,255,255,0.85);
border-radius:6px;
padding:3px 6px;
font-size:11px;
font-weight:bold;
color:#111;
border:1px solid rgba(0,0,0,0.25);
}

.legend{
background:white;
padding:12px;
font-size:12px;
box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

#tsModal{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.6);
z-index:99999;
}

#tsBox{
position:absolute;
top:50%;
left:50%;
transform:translate(-50%,-50%);
background:white;
width:90%;
max-width:900px;
border-radius:10px;
overflow:hidden;
}

#tsHeader{
background:#0b1e3f;
color:white;
padding:12px 16px;
display:flex;
justify-content:space-between;
align-items:center;
}

#tsContent{
padding:20px;
}

#timeSlider{
width:100%;
margin-top:10px;
}

#tsStats{
margin-top:10px;
font-size:14px;
}

</style>
</head>

<body>

<div id="header">
<img src="logo/logo-bapeten.png">
<h2>Indonesia Radiation Data Monitoring System</h2>
</div>

<div id="map"></div>

<div id="tsModal">

<div id="tsBox">

<div id="tsHeader">
<div id="tsTitle">Time Series</div>
<button onclick="closeTS()" style="
background:#c00;
color:white;
border:none;
padding:6px 12px;
border-radius:6px;
cursor:pointer">Close</button>
</div>

<div id="tsContent">

<canvas id="tsChart" height="120"></canvas>

<input type="range" id="timeSlider">

<div id="tsStats"></div>

</div>

</div>

</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

// BASEMAP

var osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

var map=L.map('map',{
center:[-2,118],
zoom:5,
layers:[osm]
});

// LAYERS

var polygonLayer=L.layerGroup().addTo(map);
var labelLayer=L.layerGroup().addTo(map);

// RADIUS

function getRadius(){

var z=map.getZoom();

if(z<=5) return 25000;
if(z<=6) return 20000;
if(z<=7) return 15000;
if(z<=8) return 9000;
if(z<=9) return 6000;
if(z<=10) return 3500;
if(z<=11) return 2000;

return 1200;

}

// HEX

function createHex(lat,lon,radius,color){

var coords=[];

for(var i=0;i<6;i++){

var angle=(Math.PI/180)*(60*i);

var dx=radius*Math.cos(angle);
var dy=radius*Math.sin(angle);

coords.push([
lat+(dy/111111),
lon+(dx/(111111*Math.cos(lat*Math.PI/180)))
]);

}

return L.polygon(coords,{
color:"#222",
weight:1,
fillColor:color,
fillOpacity:0.85
});

}

// COLOR

function getColor(d){

if(d==="Out of service") return "#2b83ba";

d=parseFloat(d);

if(d<1000) return "#2b83ba";
if(d<100000) return "#ffe600";
if(d<1000000) return "#ff9b00";
return "#ff2b2b";

}

// LOAD CSV

function loadCSV(){

var url="output.csv?nocache="+Date.now();

fetch(url)
.then(r=>r.text())
.then(text=>{

polygonLayer.clearLayers();
labelLayer.clearLayers();

var radius=getRadius();

var data=Papa.parse(text,{header:true}).data;

data.forEach(row=>{

if(!row["LATITUDE"]) return;

var lat=parseFloat(row["LATITUDE"]);
var lon=parseFloat(row["LONGITUDE"]);

var dose=row["Gamma Dose Rate (nSv/h)"];

var color=getColor(dose);

var hex=createHex(lat,lon,radius,color);

hex.bindPopup(
"<b>"+row["NAMA UNIT"]+"</b><br>"+
"Dose Rate: "+dose+" nSv/h<br>"+
"<a href='#' onclick=\"openTS('"+row["NAMA UNIT"]+"')\">ðŸ“ˆ Time Series</a>"
);

hex.addTo(polygonLayer);

});

});

}

loadCSV();
setInterval(loadCSV,30000);

// TIME SERIES

var tsChart;
var allLabels=[];
var allValues=[];

function openTS(station){

document.getElementById("tsModal").style.display="block";
document.getElementById("tsTitle").innerHTML="Time Series - "+station;

fetch("timeseries.csv?nocache="+Date.now())
.then(r=>r.text())
.then(text=>{

var data=Papa.parse(text,{header:true}).data;

allLabels=[];
allValues=[];

data.forEach(r=>{

if(r.station===station){

allLabels.push(r.time);
allValues.push(parseFloat(r.dose));

}

});

if(tsChart) tsChart.destroy();

if(allValues.length===0){

document.getElementById("tsStats").innerHTML="No data available";

tsChart=new Chart(document.getElementById("tsChart"),{
type:'line',
data:{labels:[],datasets:[{data:[]}]}
});

return;

}

var slider=document.getElementById("timeSlider");

slider.min=0;
slider.max=allValues.length-1;
slider.value=allValues.length-1;

updateChart(slider.value);

slider.oninput=function(){
updateChart(this.value);
};

});

}

function updateChart(index){

var labels=allLabels.slice(0,index+1);
var values=allValues.slice(0,index+1);

if(tsChart) tsChart.destroy();

tsChart=new Chart(document.getElementById("tsChart"),{

type:'line',

data:{
labels:labels,
datasets:[{
data:values,
borderColor:'#2b83ba',
backgroundColor:'rgba(43,131,186,0.15)',
tension:0.25,
pointRadius:2
}]
},

options:{
responsive:true,
plugins:{legend:{display:false}}
}

});

var avg = values.reduce((a,b)=>a+b,0)/values.length;
var min = Math.min(...values);
var max = Math.max(...values);

document.getElementById("tsStats").innerHTML=
"Average: "+avg.toFixed(2)+" nSv/h | "+
"Min: "+min.toFixed(2)+" nSv/h | "+
"Max: "+max.toFixed(2)+" nSv/h";

}

function closeTS(){
document.getElementById("tsModal").style.display="none";
}

</script>

</body>
</html>
