<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Indonesia Radiation Data Monitoring System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"/>
<link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"/>

<style>
html,body{margin:0;padding:0;font-family:Arial;}

#header{
position:absolute;
top:0;left:0;width:100%;height:70px;
background:#0b1e3f;
display:flex;align-items:center;
padding:0 25px;color:white;
z-index:9999;
}

#header img{height:42px;margin-right:15px;}
#map{position:absolute;top:70px;bottom:0;width:100%;}

.blink{
animation:blink 1s infinite;
}
@keyframes blink{
0%{opacity:1;}
50%{opacity:0.3;}
100%{opacity:1;}
}

.legend{
background:white;
padding:12px;
font-size:12px;
box-shadow:0 2px 6px rgba(0,0,0,0.3);
}
</style>
</head>

<body>

<div id="header">
<img src="logo/logo-bapeten.png">
<h2>Indonesia Radiation Data Monitoring System</h2>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<script>

// ================= MAP =================
var osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
var map=L.map('map',{center:[-2,118],zoom:5,layers:[osm]});

// ================= CLUSTER GROUP =================
var markers=L.markerClusterGroup({
disableClusteringAtZoom:12
});
map.addLayer(markers);

// ================= HEX ICON =================
function hexIcon(color, options={}){
return L.divIcon({
className: options.blink ? "blink" : "",
html:`<svg width="16" height="16" viewBox="0 0 24 24">
<polygon points="12,2 22,7 22,17 12,22 2,17 2,7"
fill="${color}"
fill-opacity="${options.opacity || 1}"
stroke="${options.stroke || 'white'}"
stroke-width="1.5"/>
</svg>`,
iconSize:[16,16]
});
}

// ================= COLOR =================
function getColor(d){
if(d==="Out of service") return "#6ad12b";
d=parseFloat(d);
if(d<1000) return "#6ad12b";
if(d<100000) return "#ffe600";
if(d<1000000) return "#ff9b00";
return "#ff2b2b";
}

// ================= LOAD CSV =================
function loadCSV(){

var url="output.csv?nocache="+Date.now();

fetch(url)
.then(r=>r.text())
.then(text=>{

markers.clearLayers();

var grouped={};

var data=Papa.parse(text,{header:true}).data;

data.forEach(row=>{

if(!row["LATITUDE"]) return;

var lat=parseFloat(row["LATITUDE"]);
var lon=parseFloat(row["LONGITUDE"]);
var key=lat+","+lon;

if(!grouped[key]) grouped[key]=[];
grouped[key].push(row);

});

// ================= CREATE MARKERS =================
Object.keys(grouped).forEach(key=>{

var rows=grouped[key];
var lat=parseFloat(rows[0]["LATITUDE"]);
var lon=parseFloat(rows[0]["LONGITUDE"]);

var firstDose=rows[0]["Gamma Dose Rate (nSv/h)"];
var color=getColor(firstDose);
var blink=false;

if(firstDose!=="Out of service"){
if(parseFloat(firstDose)>1000000) blink=true;
}

var icon;

if(firstDose==="Out of service"){
icon=hexIcon("#6ad12b",{opacity:0.35,stroke:"yellow"});
}else{
icon=hexIcon(color,{blink:blink});
}

var popupContent="";

rows.forEach(r=>{

var displayDose=r["Gamma Dose Rate (nSv/h)"];

if(displayDose!=="Out of service" && displayDose!==""){
displayDose=parseFloat(displayDose).toFixed(2);
}

popupContent+=
"<b>"+r["NAMA UNIT"]+"</b><br>"+
"Dose Rate (nSv/h): "+displayDose+"<br>"+
"Last Update (WIB): "+r["LAST UPDATE (WIB)"]+
"<hr style='margin:6px 0'>";
});

var marker=L.marker([lat,lon],{icon:icon})
.bindPopup(popupContent);

markers.addLayer(marker);

});

});
}

loadCSV();
setInterval(loadCSV,30000);

</script>

</body>
</html>
