<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Indonesia Radiation Data Monitoring System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

html,body{
margin:0;
padding:0;
font-family:Arial;
}

#header{
position:absolute;
top:0;
left:0;
width:100%;
height:70px;
background:#0b1e3f;
display:flex;
align-items:center;
padding:0 25px;
color:white;
z-index:9999;
}

#header img{
height:42px;
margin-right:15px;
}

#map{
position:absolute;
top:70px;
bottom:0;
width:100%;
}

.unit-label{
background:rgba(255,255,255,0.85);
border-radius:6px;
padding:3px 6px;
font-size:11px;
font-weight:bold;
color:#111;
border:1px solid rgba(0,0,0,0.25);
box-shadow:0 1px 3px rgba(0,0,0,0.3);
white-space:nowrap;
}

.legend{
background:white;
padding:12px;
font-size:12px;
box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

</style>
</head>

<body>

<div id="header">
<img src="logo/logo-bapeten.png">
<h2>Indonesia Radiation Data Monitoring System</h2>
</div>

<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

/* ===========================
BASEMAP
=========================== */

var osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

var dark=L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');

var googleHybrid=L.tileLayer(
'https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',
{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}
);

var googleSat=L.tileLayer(
'https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']}
);

var esriGray=L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}',
{maxZoom:16}
);

var esriGrayLabel=L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer/tile/{z}/{y}/{x}',
{maxZoom:16}
);

/* ===========================
MAP
=========================== */

var map=L.map('map',{

zoomControl:true,
zoomSnap:0.25,
zoomDelta:0.25,
wheelPxPerZoomLevel:120,

layers:[osm]

});

map.attributionControl.addAttribution("Â© DKKN-BAPETEN 2026");

var indonesiaBounds=[
[-11,94],
[6,141]
];

map.fitBounds(indonesiaBounds);

/* ===========================
LAYERS
=========================== */

var polygonLayer=L.layerGroup().addTo(map);
var labelLayer=L.layerGroup().addTo(map);

/* ===========================
LAYER CONTROL
=========================== */

L.control.layers(

{
"OpenStreetMap":osm,
"Dark":dark,
"Google Hybrid":googleHybrid,
"Google Satellite":googleSat,
"ESRI Light Gray":esriGray
},

{
"ESRI Labels":esriGrayLabel,
"Station Polygons":polygonLayer,
"Station Labels":labelLayer
}

).addTo(map);

/* ===========================
HEXAGON RADIUS
=========================== */

function getRadius(){

var zoom=map.getZoom();

var base=40000;

return Math.max(base / Math.pow(2, zoom-5), 80);

}

/* ===========================
HEXAGON CREATE
=========================== */

function createHex(lat,lon,radius,color,options={}){

var coords=[];

for(var i=0;i<6;i++){

var angle=(Math.PI/180)*(60*i);

var dx=radius*Math.cos(angle);
var dy=radius*Math.sin(angle);

coords.push([
lat+(dy/111111),
lon+(dx/(111111*Math.cos(lat*Math.PI/180)))
]);

}

return L.polygon(coords,{
color:options.stroke || "#222",
weight:options.weight || 1,
fillColor:color,
fillOpacity:options.opacity || 0.85
});

}

/* ===========================
COLOR SCALE
=========================== */

function getColor(d){

if(d==="Out of service") return "#2b83ba";

d=parseFloat(d);

if(d<1000) return "#2b83ba";
if(d<100000) return "#ffe600";
if(d<1000000) return "#ff9b00";
return "#ff2b2b";

}

/* ===========================
HEX CLUSTER
=========================== */

function createHexCluster(data){

var grid={};

data.forEach(row=>{

if(!row["LATITUDE"]) return;

var lat=parseFloat(row["LATITUDE"]);
var lon=parseFloat(row["LONGITUDE"]);

var key=
Math.round(lat*2)/2+"_"+Math.round(lon*2)/2;

if(!grid[key]) grid[key]=[];

grid[key].push(row);

});

var clusters=[];

for(var key in grid){

var group=grid[key];

var lat=0;
var lon=0;

group.forEach(g=>{
lat+=parseFloat(g["LATITUDE"]);
lon+=parseFloat(g["LONGITUDE"]);
});

lat/=group.length;
lon/=group.length;

clusters.push({
lat:lat,
lon:lon,
items:group
});

}

return clusters;

}

/* ===========================
LOAD CSV
=========================== */

function loadCSV(){

fetch("output.csv?nocache="+Date.now())

.then(r=>r.text())

.then(text=>{

polygonLayer.clearLayers();
labelLayer.clearLayers();

var radius=getRadius();

var data=Papa.parse(text,{header:true}).data;

var zoom=map.getZoom();

/* ===========================
CLUSTER MODE (ZOOM FAR)
=========================== */

if(zoom<6){

var clusters=createHexCluster(data);

clusters.forEach(c=>{

var hex=createHex(c.lat,c.lon,radius*1.3,"#2b83ba");

var popup="<b>"+c.items.length+" Stations</b><br><br>";

c.items.forEach(r=>{
popup+=r["NAMA UNIT"]+"<br>";
});

hex.bindPopup(popup);

hex.addTo(polygonLayer);

});

}

/* ===========================
NORMAL MODE (ZOOM CLOSE)
=========================== */

else{

data.forEach(row=>{

if(!row["LATITUDE"]) return;

var lat=parseFloat(row["LATITUDE"]);
var lon=parseFloat(row["LONGITUDE"]);

var dose=row["Gamma Dose Rate (nSv/h)"];

var color=getColor(dose);

var hex;

if(dose==="Out of service"){

hex=createHex(lat,lon,radius,color,{
opacity:0.35,
stroke:"#004a8f",
weight:2
});

}else{

hex=createHex(lat,lon,radius,color,{
opacity:0.85
});

}

var doseText="";

if(dose==="Out of service"){

doseText="Dose Rate: Out of service";

}else{

doseText="Dose Rate: "+parseFloat(dose).toFixed(2)+" nSv/h";

}

var popupContent=
"<b>"+row["NAMA UNIT"]+"</b><br>"+
doseText+"<br>"+
"Last Update: "+row["LAST UPDATE (WIB)"];

hex.bindPopup(popupContent);

hex.addTo(polygonLayer);

/* LABEL */

var labelOffsetLat=lat+(radius/111111)*0.9;
var labelOffsetLon=lon+(radius/(111111*Math.cos(lat*Math.PI/180)))*0.9;

var label=L.marker([labelOffsetLat,labelOffsetLon],{

icon:L.divIcon({
className:'',
html:'<div class="unit-label">'+row["NAMA UNIT"]+'</div>',
iconSize:null
})

});

label.addTo(labelLayer);

});

}

});

}

/* ===========================
AUTO UPDATE
=========================== */

loadCSV();

setInterval(loadCSV,30000);

map.on("zoomend",loadCSV);

/* ===========================
LEGEND
=========================== */

var legend=L.control({position:"bottomleft"});

legend.onAdd=function(){

var div=L.DomUtil.create("div","legend");

div.innerHTML=`

<b>IAEA Operational Intervention Levels</b><br><br>

<div style="width:260px;height:14px;
background:linear-gradient(to right,#2b83ba,#ffe600,#ff9b00,#ff2b2b);
margin-bottom:6px;border:1px solid #999;"></div>

<div style="display:flex;justify-content:space-between;width:260px;font-size:11px;">
<span>0</span>
<span>1,000</span>
<span>100,000</span>
<span>1,000,000</span>
</div>

<div style="font-size:11px;margin-top:4px;">
Gamma Dose Rate (nSv/h)
</div>

`;

return div;

};

legend.addTo(map);

</script>

</body>
</html>
