<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Indonesia Radiation Data Monitoring System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

html,body{
margin:0;
padding:0;
font-family:Arial;
}

#header{
position:absolute;
top:0;
left:0;
width:100%;
height:70px;
background:#0b1e3f;
display:flex;
align-items:center;
padding:0 25px;
color:white;
z-index:9999;
}

#header img{
height:42px;
margin-right:15px;
}

#map{
position:absolute;
top:70px;
bottom:0;
width:100%;
}

.unit-label{
background:rgba(255,255,255,0.9);
border-radius:6px;
padding:3px 6px;
font-size:11px;
font-weight:bold;
border:1px solid rgba(0,0,0,0.3);
}

.legend{
background:white;
padding:12px;
font-size:12px;
box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

/* TIME SERIES */

#tsModal{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.6);
z-index:99999;
}

#tsBox{
position:absolute;
top:50%;
left:50%;
transform:translate(-50%,-50%);
background:white;
width:90%;
max-width:900px;
border-radius:10px;
overflow:hidden;
}

#tsHeader{
background:#0b1e3f;
color:white;
padding:12px;
display:flex;
justify-content:space-between;
}

#tsContent{
padding:20px;
}

</style>
</head>

<body>

<div id="header">
<img src="logo/logo-bapeten.png">
<h2>Indonesia Radiation Data Monitoring System</h2>
</div>

<div id="map"></div>

<div id="tsModal">
<div id="tsBox">

<div id="tsHeader">
<div id="tsTitle">Time Series</div>
<button onclick="closeTS()">Close</button>
</div>

<div id="tsContent">
<canvas id="tsChart" height="120"></canvas>
</div>

</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

/* BASEMAP */

var osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');

var esriGray=L.tileLayer(
'https://server.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer/tile/{z}/{y}/{x}'
);

/* MAP */

var map=L.map('map',{
zoomControl:true,
layers:[osm],

zoomSnap:0.25,          // zoom bisa 0.25 level
zoomDelta:0.25,         // tombol + - juga 0.25
wheelPxPerZoomLevel:120 // scroll mouse tidak terlalu sensitif
});

map.fitBounds([[-11,94],[6,141]]);

/* LAYERS */

var polygonLayer=L.layerGroup().addTo(map);
var labelLayer=L.layerGroup().addTo(map);

/* COLOR */

function getColor(d){

if(d==="Out of service") return "#2b83ba";

d=parseFloat(d);

if(d<1000) return "#2b83ba";
if(d<100000) return "#ffe600";
if(d<1000000) return "#ff9b00";

return "#ff2b2b";

}

/* HEXAGON */

function createHex(lat,lon,r){

var pts=[];

for(var i=0;i<6;i++){

var angle=(Math.PI/180)*(60*i);

var dx=r*Math.cos(angle);
var dy=r*Math.sin(angle);

pts.push([
lat+(dy/111111),
lon+(dx/(111111*Math.cos(lat*Math.PI/180)))
]);

}

return pts;

}

/* HONEYCOMB GRID POSITION */

function snapToHexGrid(lat,lon,size){

var x=lon/(size*1.5);
var y=lat/(size*Math.sqrt(3));

var rx=Math.round(x);
var ry=Math.round(y);

var snappedLon=rx*(size*1.5);
var snappedLat=ry*(size*Math.sqrt(3));

return [snappedLat,snappedLon];

}

/* LOAD CSV */

function loadCSV(){

fetch("output.csv?"+Date.now())

.then(r=>r.text())

.then(text=>{

polygonLayer.clearLayers();
labelLayer.clearLayers();

var data=Papa.parse(text,{header:true}).data;

var zoom=map.getZoom();

var hexSize=0.35;

var grid={};

data.forEach(row=>{

if(!row["LATITUDE"]) return;

var lat=parseFloat(row["LATITUDE"]);
var lon=parseFloat(row["LONGITUDE"]);

var snapped=snapToHexGrid(lat,lon,hexSize);

var key=snapped[0]+"_"+snapped[1];

if(!grid[key]) grid[key]=[];

grid[key].push(row);

});

/* DRAW HEX */

for(var key in grid){

var group=grid[key];

var lat=parseFloat(key.split("_")[0]);
var lon=parseFloat(key.split("_")[1]);

var dose=group[0]["Gamma Dose Rate (nSv/h)"];

var hex=L.polygon(
createHex(lat,lon,30000),
{
color:"#333",
weight:1,
fillColor:getColor(dose),
fillOpacity:0.85
}
).addTo(polygonLayer);

/* POPUP */

if(group.length>1){

var html="<b>"+group.length+" Stations</b><br>";

group.forEach(s=>{
html+=s["NAMA UNIT"]+"<br>";
});

hex.bindPopup(html);

}else{

var s=group[0];

var html=
"<b>"+s["NAMA UNIT"]+"</b><br>"+
"Dose Rate: "+s["Gamma Dose Rate (nSv/h)"]+" nSv/h<br>"+
"Last Update: "+s["LAST UPDATE (WIB)"]+
"<br><br><a href='#' onclick=\"openTS('"+s["NAMA UNIT"]+"')\">View Time Series</a>";

hex.bindPopup(html);

}

/* LABEL */

if(zoom>7){

var label=L.marker([lat,lon],{

icon:L.divIcon({
html:'<div class="unit-label">'+group[0]["NAMA UNIT"]+'</div>'
})

});

label.addTo(labelLayer);

}

}

});

}

loadCSV();
setInterval(loadCSV,30000);

map.on("zoomend",loadCSV);

/* TIME SERIES */

var tsChart;

function openTS(station){

document.getElementById("tsModal").style.display="block";
document.getElementById("tsTitle").innerHTML="Time Series - "+station;

fetch("timeseries.csv?"+Date.now())

.then(r=>r.text())

.then(text=>{

var data=Papa.parse(text,{header:true}).data;

var labels=[];
var values=[];

data.forEach(r=>{
if(r.station===station){
labels.push(r.time);
values.push(parseFloat(r.dose));
}
});

if(tsChart) tsChart.destroy();

tsChart=new Chart(document.getElementById("tsChart"),{

type:'line',

data:{
labels:labels,
datasets:[{
data:values,
borderColor:'#2b83ba',
tension:0.3,
fill:false
}]
},

options:{
plugins:{legend:{display:false}},
scales:{
y:{title:{display:true,text:"nSv/h"}}
}
}

});

});

}

function closeTS(){
document.getElementById("tsModal").style.display="none";
}

/* LEGEND */

var legend=L.control({position:"bottomleft"});

legend.onAdd=function(){

var div=L.DomUtil.create("div","legend");

div.innerHTML=`
<b>Gamma Dose Rate</b><br><br>

<div style="width:220px;height:14px;
background:linear-gradient(to right,#2b83ba,#ffe600,#ff9b00,#ff2b2b);
border:1px solid #999;"></div>

<div style="display:flex;justify-content:space-between;font-size:11px">
<span>0</span>
<span>1k</span>
<span>100k</span>
<span>1M</span>
</div>
`;

return div;

};

legend.addTo(map);

</script>

</body>
</html>

