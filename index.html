<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">

<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">

<title>Indonesia Radiation Data Monitoring System</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>

html,body{
margin:0;
padding:0;
font-family:Arial;
}

#header{
position:absolute;
top:0;
left:0;
width:100%;
height:70px;
background:#0b1e3f;
display:flex;
align-items:center;
padding:0 25px;
color:white;
z-index:9999;
}

#header img{
height:42px;
margin-right:15px;
}

#map{
position:absolute;
top:70px;
bottom:0;
width:100%;
}

.unit-label{
background:rgba(255,255,255,0.85);
border-radius:6px;
padding:3px 6px;
font-size:11px;
font-weight:bold;
color:#111;
border:1px solid rgba(0,0,0,0.25);
box-shadow:0 1px 3px rgba(0,0,0,0.3);
white-space:nowrap;
}

.legend{
background:white;
padding:12px;
font-size:12px;
box-shadow:0 2px 6px rgba(0,0,0,0.3);
}

.leaflet-popup-content{
font-size:14px;
}

@media (max-width:768px){
.leaflet-popup-content{
font-size:18px;
}
}

/* TIME SERIES */

#tsModal{
display:none;
position:fixed;
top:0;
left:0;
width:100%;
height:100%;
background:rgba(0,0,0,0.6);
z-index:99999;
}

#tsBox{
position:absolute;
top:50%;
left:50%;
transform:translate(-50%,-50%);
background:white;
width:90%;
max-width:900px;
border-radius:10px;
overflow:hidden;
}

#tsHeader{
background:#0b1e3f;
color:white;
padding:12px 16px;
display:flex;
justify-content:space-between;
align-items:center;
font-weight:bold;
}

#tsContent{
padding:20px;
}

#timeSlider{
width:100%;
margin-top:10px;
}

#selectedTime{
margin-top:6px;
font-size:12px;
color:#444;
}

#tsStats{
margin-top:10px;
font-size:14px;
}

</style>
</head>

<body>

<div id="header">
<img src="logo/logo-bapeten.png">
<h2>Indonesia Radiation Data Monitoring System</h2>
</div>

<div id="map"></div>

<div id="tsModal">
<div id="tsBox">

<div id="tsHeader">
<div id="tsTitle">Time Series</div>
<button onclick="closeTS()" style="background:#c00;color:white;border:none;padding:6px 12px;border-radius:6px;cursor:pointer">Close</button>
</div>

<div id="tsContent">
<canvas id="tsChart" height="120"></canvas>
<input type="range" id="timeSlider">
<div id="selectedTime"></div>
<div id="tsStats"></div>
</div>

</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>

// BASEMAP

var osm=L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png');
var dark=L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
var googleHybrid=L.tileLayer('https://{s}.google.com/vt/lyrs=y&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']});
var googleSat=L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',{maxZoom:20,subdomains:['mt0','mt1','mt2','mt3']});

// MAP

var map=L.map('map',{center:[-2,118],zoom:5,layers:[osm]});

// LAYERS

var polygonLayer=L.layerGroup().addTo(map);
var labelLayer=L.layerGroup().addTo(map);

// LAYER CONTROL

L.control.layers(
{
"OpenStreetMap":osm,
"Dark":dark,
"Google Hybrid":googleHybrid,
"Google Satellite":googleSat
},
{
"Station Polygons":polygonLayer,
"Station Labels":labelLayer
}
).addTo(map);

// RADIUS

function getRadius(){
var z=map.getZoom();
if(z<=5) return 25000;
if(z<=6) return 20000;
if(z<=7) return 15000;
if(z<=8) return 9000;
if(z<=9) return 6000;
if(z<=10) return 3500;
if(z<=11) return 2000;
return 1200;
}

// HEXAGON

function createHex(lat,lon,radius,color,options={}){

var coords=[];

for(var i=0;i<6;i++){

var angle=(Math.PI/180)*(60*i);
var dx=radius*Math.cos(angle);
var dy=radius*Math.sin(angle);

coords.push([
lat+(dy/111111),
lon+(dx/(111111*Math.cos(lat*Math.PI/180)))
]);

}

return L.polygon(coords,{
color:options.stroke || "#222",
weight:options.weight || 1,
fillColor:color,
fillOpacity:options.opacity || 0.85
});

}

// COLOR

function getColor(d){

if(d==="Out of service") return "#2b83ba";

d=parseFloat(d);

if(d<1000) return "#2b83ba";
if(d<100000) return "#ffe600";
if(d<1000000) return "#ff9b00";
return "#ff2b2b";

}

// LOAD CSV

function loadCSV(){

fetch("output.csv?nocache="+Date.now())
.then(r=>r.text())
.then(text=>{

polygonLayer.clearLayers();
labelLayer.clearLayers();

var radius=getRadius();
var data=Papa.parse(text,{header:true}).data;

data.forEach(row=>{

if(!row["LATITUDE"]) return;

var lat=parseFloat(row["LATITUDE"]);
var lon=parseFloat(row["LONGITUDE"]);
var dose=row["Gamma Dose Rate (nSv/h)"];
var color=getColor(dose);

var hex;

if(dose==="Out of service"){

hex=createHex(lat,lon,radius,color,{opacity:0.35,stroke:"#004a8f",weight:2});

}else{

hex=createHex(lat,lon,radius,color,{opacity:0.85});

}

var displayDose=row["Gamma Dose Rate (nSv/h)"];

if(displayDose!=="Out of service" && displayDose!==""){
displayDose=parseFloat(displayDose).toFixed(2);
}

var popupContent=
"<b>"+row["NAMA UNIT"]+"</b><br>"+
"Dose Rate: "+displayDose+" nSv/h<br>"+
"Last Update: "+row["LAST UPDATE (WIB)"]+"<br><br>"+
"<a href='#' onclick=\"openTS('"+row["NAMA UNIT"]+"')\">View Time Series</a>";

hex.bindPopup(popupContent,{maxWidth:280,minWidth:180});
hex.addTo(polygonLayer);

// LABEL

var labelOffsetLat = lat + (radius/111111)*0.9;
var labelOffsetLon = lon + (radius/(111111*Math.cos(lat*Math.PI/180)))*0.9;

var label=L.marker([labelOffsetLat,labelOffsetLon],{
icon:L.divIcon({
className:'',
html:'<div class="unit-label">'+row["NAMA UNIT"]+'</div>',
iconSize:null
})
});

label.addTo(labelLayer);

});

});

}

loadCSV();
setInterval(loadCSV,30000);
map.on("zoomend",loadCSV);

// TIME SERIES

var tsChart=null;
var allLabels=[];
var allValues=[];

function openTS(station){

document.getElementById("tsModal").style.display="block";
document.getElementById("tsTitle").innerHTML="Time Series - "+station;

allLabels=[];
allValues=[];

if(tsChart){
tsChart.destroy();
tsChart=null;
}

document.getElementById("selectedTime").innerHTML="";
document.getElementById("tsStats").innerHTML="";

fetch("timeseries.csv?nocache="+Date.now())
.then(r=>r.text())
.then(text=>{

var data=Papa.parse(text,{header:true}).data;

data.forEach(r=>{
if(r.station===station){
allLabels.push(r.time);
allValues.push(parseFloat(r.dose));
}
});

if(allValues.length===0){
document.getElementById("tsStats").innerHTML="No data available";
return;
}

var slider=document.getElementById("timeSlider");

slider.min=0;
slider.max=allValues.length-1;
slider.step=5;

var lastIndex=allValues.length-1;
slider.value=lastIndex;

updateChart(lastIndex);

slider.oninput=function(){
updateChart(parseInt(this.value));
};

});

}

function updateChart(index){

var labels=allLabels.slice(0,index+1);
var values=allValues.slice(0,index+1);

var startTime=labels[0];
var endTime=labels[labels.length-1];

document.getElementById("selectedTime").innerHTML=
"Selected Time : "+startTime+" â€“ "+endTime;

var avg=values.reduce((a,b)=>a+b,0)/values.length;
var min=Math.min(...values);
var max=Math.max(...values);

var ymin=min-(max-min)*0.2;
var ymax=max+(max-min)*0.2;

if(ymin<0) ymin=0;

if(tsChart) tsChart.destroy();

tsChart=new Chart(document.getElementById("tsChart"),{

type:'line',

data:{
labels:labels,
datasets:[{
data:values,
borderColor:'#2b83ba',
backgroundColor:'rgba(43,131,186,0.15)',
tension:0.25,
pointRadius:2,
fill:true
}]
},

options:{
responsive:true,
plugins:{legend:{display:false}},
scales:{
y:{
min:ymin,
max:ymax,
title:{display:true,text:"nSv/h"}
}
}
}

});

document.getElementById("tsStats").innerHTML=
"<b>Average:</b> "+avg.toFixed(2)+" nSv/h | "+
"<b>Min:</b> "+min.toFixed(2)+" nSv/h | "+
"<b>Max:</b> "+max.toFixed(2)+" nSv/h";

}

function closeTS(){
document.getElementById("tsModal").style.display="none";
}

// LEGEND

var legend=L.control({position:"bottomleft"});

legend.onAdd=function(){

var div=L.DomUtil.create("div","legend");

div.innerHTML=`

<b>IAEA Operational Intervention Levels</b><br><br>

<div style="width:260px;height:14px;
background:linear-gradient(to right,#2b83ba,#ffe600,#ff9b00,#ff2b2b);
margin-bottom:6px;border:1px solid #999;"></div>

<div style="display:flex;justify-content:space-between;width:260px;font-size:11px;">
<span>0</span>
<span>1,000</span>
<span>100,000</span>
<span>1,000,000</span>
</div>

<div style="font-size:11px;margin-top:4px;">
Gamma Dose Rate (nSv/h)
</div>

`;

return div;

};

legend.addTo(map);

</script>

</body>
</html>
